---
title: "Human Volunteer Study - Differential Abundance Testing"
author: "Scott A. Handley and Barry Hykes Jr."
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=10,
                      fig.height=10,
                      fig.path="./figures/",
                      warning=FALSE,
                      message=FALSE)
```

```{r initiate-environment, include=FALSE}
library("tidyverse")
packageVersion("tidyverse")
library("phyloseq")
packageVersion("phyloseq")
library("RColorBrewer")
packageVersion("RColorBrewer")
library("vegan")
packageVersion("vegan")
library("gridExtra")
packageVersion("gridExtra")
library("knitr")
packageVersion("knitr")
library("DESeq2")
packageVersion("DeSeq2")
library("plotly")
packageVersion("plotly")
library("microbiome")
packageVersion("microbiome")
library("ggpubr")
packageVersion("ggpubr")
library("randomForest")
packageVersion("randomForest")
library("data.table")
packageVersion("data.table")
library("HH")
packageVersion("HH")
library("mgcv")
packageVersion("mgcv")
library("pheatmap")
packageVersion("pheatmap")

```

```{r global-theme-settings, include=FALSE}
# Set global theming
theme_set(theme_bw(base_size = 10,
                   base_family = "Helvetica"))

```
##Load phyloseq data generated from dada2

```{r initiate-data}
# Load Phyloseq object generated in HIV_oral_preprocessing.Rmd
# Options include GreenGenes, SILVA, RDP and HitDB
ps1 <- readRDS("~/Dropbox/Research/human_volunteer/results/ps1.RDS")
ps1

# View sample variables & generate basic stats
sample_variables(ps1)
sd(sample_sums(ps1))
get_taxa_unique(ps1, "Phylum")

```

```{r subsetting, include = FALSE}
# Subset. Always subset after taxa/sample filtering
# Time 1 (Day -9)
ps1.t1 <- subset_samples(ps1, day == "-9")
sample_data(ps1.t1)$day
ps1.t1
ps1.t1.con <- subset_samples(ps1.t1, randomization_arm == "No antibiotics")
sample_data(ps1.t1.con)$randomization_arm
ps1.t1.narrow <- subset_samples(ps1.t1, randomization_arm == "Narrow spectrum antibiotics")
sample_data(ps1.t1.narrow)$randomization_arm
ps1.t1.broad <- subset_samples(ps1.t1, randomization_arm == "Broad spectrum antibiotics")
sample_data(ps1.t1.broad)$randomization_arm

# Time 2 (Day 0)
ps1.t2 <- subset_samples(ps1, day == "0")
ps1.t2

# Time 3 (Day 7)
ps1.t3 <- subset_samples(ps1, day == "7")
ps1.t3

# No antibiotics (control)
ps1.con <- subset_samples(ps1, randomization_arm == "No antibiotics")
ps1.con

# Narrow spectrum antibiotics
ps1.narrow <- subset_samples(ps1, randomization_arm == "Narrow spectrum antibiotics")
ps1.narrow

# Broad spectrum antibiotics
ps1.broad <- subset_samples(ps1, randomization_arm == "Broad spectrum antibiotics")
ps1.broad

```

##Differential abundance testing

```{r LRT-diff-abund-testing-data-prep, include=FALSE}
# Time series should be set as a factor per DeSeq2 recommendations
class(sample_data(ps1.con)$day)
sample_data(ps1.con)$day <- factor(sample_data(ps1.con)$day)
class(sample_data(ps1.con)$day)

class(sample_data(ps1.narrow)$day)
sample_data(ps1.narrow)$day <- factor(sample_data(ps1.narrow)$day)
class(sample_data(ps1.narrow)$day)

class(sample_data(ps1.broad)$day)
sample_data(ps1.broad)$day <- factor(sample_data(ps1.broad)$day)
class(sample_data(ps1.broad)$day)

# Calculate geometric means prior to estimate size factors
# This is required for data sets with lots of zeros
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

```

##**Likelihood ratio test:** Identifying taxa differentially abundant in one or more time points between 1) patients who boosted versus thoses that did not and 2) patients that shed rotavirus in their stool and those that did not

**1) Rotavirus Boost or Not**

Only testing for categories where there were > 2 samples per variable (boost or Shedding)

**BOOST: NARROW SPECTRUM ANTIBIOTICS SAMPLES**
```{r diff-abund-rotaboost-narrow-LRT}
# Test for taxa which at one or more time points after time 0 showed a d7-rota-boost-specific effect
# Convert phyloseq object to DeSeq2 table
ds.boost.narrow.LRT <- phyloseq_to_deseq2(ps1.narrow, ~d7_rota_boost_updated + day + d7_rota_boost_updated:day)

# Calculate geometric means prior to estimate size factors
geoMeans.ds.boost.narrow.LRT <- apply(counts(ds.boost.narrow.LRT), 1, gm_mean)
ds.boost.narrow.LRT <- estimateSizeFactors(ds.boost.narrow.LRT, geoMeans = geoMeans.ds.boost.narrow.LRT)

# Run DeSeq2
dds.boost.narrow.LRT <- DESeq(ds.boost.narrow.LRT, test="LRT", reduced = ~d7_rota_boost_updated + day)

# Tabulate results
res.dds.boost.narrow.LRT = results(dds.boost.narrow.LRT)
res.dds.boost.narrow.LRT$symbol <- mcols(dds.boost.narrow.LRT)$symbol
head(res.dds.boost.narrow.LRT[order(res.dds.boost.narrow.LRT$padj), ], 4)
write.table(res.dds.boost.narrow.LRT, file = "./results/deseq_rotaboost_narrow_LRT.txt", sep = "\t")
mcols(res.dds.boost.narrow.LRT)
summary(res.dds.boost.narrow.LRT)

# Plot taxa with lowest p-value
fiss.dds.boost.narrow.LRT <- plotCounts(dds.boost.narrow.LRT, which.min(res.dds.boost.narrow.LRT$padj), 
                   intgroup = c("day","d7_rota_boost_updated"), returnData = TRUE)
ggplot(fiss.dds.boost.narrow.LRT,
  aes(x = as.numeric(day), y = count, color = d7_rota_boost_updated, group = d7_rota_boost_updated)) + 
  geom_point() + geom_smooth(se = FALSE, method = "loess") + scale_y_log10()

```

**Interpretation:** There are no differentially abundant taxa in any of the randomization arms at any time point between samples that boosted and those that did not boost in narrow spectrum antibiotics treated samples.

**2) Shedding or Not:** Control samples not analyzed as two few shedders in that group.

**Shedding: NARROW SPECTRUM ANTIBIOTICS SAMPLES**
```{r diff-abund-Shedding-narrow-LRT}
# Test for taxa which at one or more time points after time 0 showed a Shedding-specific effect
# Convert phyloseq object to DeSeq2 table
ds.Shedding.narrow.LRT <- phyloseq_to_deseq2(ps1.narrow, ~Shedding + day + Shedding:day)

# Calculate geometric means prior to estimate size factors
geoMeans.ds.Shedding.narrow.LRT <- apply(counts(ds.Shedding.narrow.LRT), 1, gm_mean)
ds.Shedding.narrow.LRT <- estimateSizeFactors(ds.Shedding.narrow.LRT, geoMeans = geoMeans.ds.Shedding.narrow.LRT)

# Run DeSeq2
dds.Shedding.narrow.LRT <- DESeq(ds.Shedding.narrow.LRT, test="LRT", reduced = ~Shedding + day)

# Tabulate results
res.dds.Shedding.narrow.LRT = results(dds.Shedding.narrow.LRT)
res.dds.Shedding.narrow.LRT$symbol <- mcols(dds.Shedding.narrow.LRT)$symbol
head(res.dds.Shedding.narrow.LRT[order(res.dds.Shedding.narrow.LRT$padj), ], 4)
write.table(res.dds.Shedding.narrow.LRT, file = "./results/deseq_Shedding_narrow_LRT.txt", sep = "\t")
mcols(res.dds.Shedding.narrow.LRT)
summary(res.dds.Shedding.narrow.LRT)

# Plot taxa with lowest p-value
fiss.dds.Shedding.narrow.LRT <- plotCounts(dds.Shedding.narrow.LRT, which.min(res.dds.Shedding.narrow.LRT$padj), 
                   intgroup = c("day","d7_rota_boost_updated"), returnData = TRUE)
ggplot(fiss.dds.Shedding.narrow.LRT,
  aes(x = as.numeric(day), y = count, color = d7_rota_boost_updated, group = d7_rota_boost_updated)) + 
  geom_point() + geom_smooth(se = FALSE, method = "loess") + scale_y_log10()

```

**Interpretation:** There are no differentially abundant taxa in any of the randomization arms at any time point between samples that shed rotavirus and those that did not.

**Pairwise differential abundance testing

**DAY 7**

**BOOST: Day 7 Control**
```{r differential-abundance-testing-boost-d7-control}
sample_data(ps1)$day
ps1.d7.con <- subset_samples(ps1.con, day == "7")
sample_data(ps1.d7.con)$day
sample_data(ps1.d7.con)$randomization_arm

# Differential Abundance Testing
ds.d7.con <- phyloseq_to_deseq2(ps1.d7.con, ~d7_rota_boost_updated)

geoMeans.ds.d7.con <- apply(counts(ds.d7.con), 1, gm_mean)
ds.d7.con <- estimateSizeFactors(ds.d7.con, geoMeans = geoMeans.ds.d7.con)

dds.d7.con <- DESeq(ds.d7.con, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.con = results(dds.d7.con, cooksCutoff = FALSE)
sigtab_dds.dds.d7.con = res.dds.d7.con[which(res.dds.d7.con$padj < alpha), ]
sigtab_dds.dds.d7.con = cbind(as(sigtab_dds.dds.d7.con, "data.frame"), as(tax_table(ps1.d7.con)[rownames(sigtab_dds.dds.d7.con), ], "matrix"))
summary(res.dds.d7.con)
head(sigtab_dds.dds.d7.con)
write.table(sigtab_dds.dds.d7.con, file="./results/deseq_d7_con_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.con, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.con = data.table(as(results(dds.d7.con, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.con, "rn", "OTU")
taxdt.dds.d7.com = data.table(data.frame(as(tax_table(ps1.d7.con), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d7.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d7.com, "OTU")
setkeyv(resdt.dds.d7.con, "OTU")
resdt.dds.d7.con <- taxdt.dds.d7.com[resdt.dds.d7.con]
resdt.dds.d7.con
resdt.dds.d7.con[, Significant := padj < alpha]
resdt.dds.d7.con[!is.na(Significant)]
resdt.dds.d7.con

volcano.d7.con.boost = ggplot(
  data = resdt.dds.d7.con[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.con[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Control ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.con.boost
summary(res.dds.d7.con)
mcols(res.dds.d7.con, use.names = TRUE)

ggplotly(volcano.d7.con.boost)

```

**BOOST: Day 7 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d7-narrow}
sample_data(ps1)$day
ps1.d7.narrow <- subset_samples(ps1.narrow, day == "7")
sample_data(ps1.d7.narrow)$day
sample_data(ps1.d7.narrow)$randomization_arm

# Differential Abundance Testing
ds.d7.narrow <- phyloseq_to_deseq2(ps1.d7.narrow, ~d7_rota_boost_updated)

geoMeans.ds.d7.narrow <- apply(counts(ds.d7.narrow), 1, gm_mean)
ds.d7.narrow <- estimateSizeFactors(ds.d7.narrow, geoMeans = geoMeans.ds.d7.narrow)

dds.d7.narrow <- DESeq(ds.d7.narrow, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.narrow = results(dds.d7.narrow, cooksCutoff = FALSE)
sigtab_dds.dds.d7.narrow = res.dds.d7.narrow[which(res.dds.d7.narrow$padj < alpha), ]
sigtab_dds.dds.d7.narrow = cbind(as(sigtab_dds.dds.d7.narrow, "data.frame"), as(tax_table(ps1.d7.narrow)[rownames(sigtab_dds.dds.d7.narrow), ], "matrix"))
summary(res.dds.d7.narrow)
head(sigtab_dds.dds.d7.narrow)
write.table(sigtab_dds.dds.d7.narrow, file="./results/deseq_d7_narrow_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.narrow, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.narrow = data.table(as(results(dds.d7.narrow, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.narrow, "rn", "OTU")
taxdt.dds.d7.com = data.table(data.frame(as(tax_table(ps1.d7.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d7.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d7.com, "OTU")
setkeyv(resdt.dds.d7.narrow, "OTU")
resdt.dds.d7.narrow <- taxdt.dds.d7.com[resdt.dds.d7.narrow]
resdt.dds.d7.narrow
resdt.dds.d7.narrow[, Significant := padj < alpha]
resdt.dds.d7.narrow[!is.na(Significant)]
resdt.dds.d7.narrow

volcano.d7.narrow.boost = ggplot(
  data = resdt.dds.d7.narrow[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.narrow[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Narrow Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.narrow.boost
summary(res.dds.d7.narrow)
mcols(res.dds.d7.narrow, use.names = TRUE)

ggplotly(volcano.d7.narrow.boost)

```

**BOOST: Day 7 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d7-broad}
sample_data(ps1)$day
ps1.d7.broad <- subset_samples(ps1.broad, day == "7")
sample_data(ps1.d7.broad)$day

# Differential Abundance Testing
ds.d7.broad <- phyloseq_to_deseq2(ps1.d7.broad, ~d7_rota_boost_updated)

geoMeans.ds.d7.broad <- apply(counts(ds.d7.broad), 1, gm_mean)
ds.d7.broad <- estimateSizeFactors(ds.d7.broad, geoMeans = geoMeans.ds.d7.broad)

dds.d7.broad <- DESeq(ds.d7.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.broad = results(dds.d7.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d7.broad = res.dds.d7.broad[which(res.dds.d7.broad$padj < alpha), ]
sigtab_dds.dds.d7.broad = cbind(as(sigtab_dds.dds.d7.broad, "data.frame"), as(tax_table(ps1.d7.broad)[rownames(sigtab_dds.dds.d7.broad), ], "matrix"))
summary(res.dds.d7.broad)
head(sigtab_dds.dds.d7.broad)
write.table(sigtab_dds.dds.d7.broad, file="./results/deseq_d7_broad_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.broad = data.table(as(results(dds.d7.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.broad, "rn", "OTU")
taxdt.dds.d7.com = data.table(data.frame(as(tax_table(ps1.d7.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d7.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d7.com, "OTU")
setkeyv(resdt.dds.d7.broad, "OTU")
resdt.dds.d7.broad <- taxdt.dds.d7.com[resdt.dds.d7.broad]
resdt.dds.d7.broad
resdt.dds.d7.broad[, Significant := padj < alpha]
resdt.dds.d7.broad[!is.na(Significant)]
resdt.dds.d7.broad

volcano.d7.broad.boost = ggplot(
  data = resdt.dds.d7.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Broad Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.broad.boost
summary(res.dds.d7.broad)
mcols(res.dds.d7.broad, use.names = TRUE)

ggplotly(volcano.d7.broad.boost)

```

```{r day7-boost-grid}
grid.arrange(volcano.d7.con.boost, volcano.d7.narrow.boost, volcano.d7.broad.boost, ncol = 3)

```

**BOOST: Day 0 Control**
```{r differential-abundance-testing-boost-d0-control}
sample_data(ps1)$day
ps1.d0.con <- subset_samples(ps1.con, day == "0")
sample_data(ps1.d0.con)$day
sample_data(ps1.d0.con)$randomization_arm

# Differential Abundance Testing
ds.d0.con <- phyloseq_to_deseq2(ps1.d0.con, ~d7_rota_boost_updated)

geoMeans.ds.d0.con <- apply(counts(ds.d0.con), 1, gm_mean)
ds.d0.con <- estimateSizeFactors(ds.d0.con, geoMeans = geoMeans.ds.d0.con)

dds.d0.con <- DESeq(ds.d0.con, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d0.con = results(dds.d0.con, cooksCutoff = FALSE)
sigtab_dds.dds.d0.con = res.dds.d0.con[which(res.dds.d0.con$padj < alpha), ]
sigtab_dds.dds.d0.con = cbind(as(sigtab_dds.dds.d0.con, "data.frame"), as(tax_table(ps1.d0.con)[rownames(sigtab_dds.dds.d0.con), ], "matrix"))
summary(res.dds.d0.con)
head(sigtab_dds.dds.d0.con)
write.table(sigtab_dds.dds.d0.con, file="./results/deseq_d7_con_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d0.con, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d0.con = data.table(as(results(dds.d0.con, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d0.con, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d0.con), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d0.con, "OTU")
resdt.dds.d0.con <- taxdt.dds.d0.com[resdt.dds.d0.con]
resdt.dds.d0.con
resdt.dds.d0.con[, Significant := padj < alpha]
resdt.dds.d0.con[!is.na(Significant)]
resdt.dds.d0.con

volcano.d0.con.boost = ggplot(
  data = resdt.dds.d0.con[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d0.con[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 0 Control ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d0.con.boost
summary(res.dds.d0.con)
mcols(res.dds.d0.con, use.names = TRUE)

ggplotly(volcano.d0.con.boost)

```

**BOOST: Day 0 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d0-narrow}
sample_data(ps1)$day
ps1.d0.narrow <- subset_samples(ps1.narrow, day == "0")
sample_data(ps1.d0.narrow)$day
sample_data(ps1.d0.narrow)$randomization_arm

# Differential Abundance Testing
ds.d0.narrow <- phyloseq_to_deseq2(ps1.d0.narrow, ~d7_rota_boost_updated)

geoMeans.ds.d0.narrow <- apply(counts(ds.d0.narrow), 1, gm_mean)
ds.d0.narrow <- estimateSizeFactors(ds.d0.narrow, geoMeans = geoMeans.ds.d0.narrow)

dds.d0.narrow <- DESeq(ds.d0.narrow, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d0.narrow = results(dds.d0.narrow, cooksCutoff = FALSE)
sigtab_dds.dds.d0.narrow = res.dds.d0.narrow[which(res.dds.d0.narrow$padj < alpha), ]
sigtab_dds.dds.d0.narrow = cbind(as(sigtab_dds.dds.d0.narrow, "data.frame"), as(tax_table(ps1.d0.narrow)[rownames(sigtab_dds.dds.d0.narrow), ], "matrix"))
summary(res.dds.d0.narrow)
head(sigtab_dds.dds.d0.narrow)
write.table(sigtab_dds.dds.d0.narrow, file="./results/deseq_d7_narrow_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d0.narrow, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d0.narrow = data.table(as(results(dds.d0.narrow, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d0.narrow, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d0.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d0.narrow, "OTU")
resdt.dds.d0.narrow <- taxdt.dds.d0.com[resdt.dds.d0.narrow]
resdt.dds.d0.narrow
resdt.dds.d0.narrow[, Significant := padj < alpha]
resdt.dds.d0.narrow[!is.na(Significant)]
resdt.dds.d0.narrow

volcano.d0.narrow.boost = ggplot(
  data = resdt.dds.d0.narrow[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d0.narrow[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 0 Narrow Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d0.narrow.boost
summary(res.dds.d0.narrow)
mcols(res.dds.d0.narrow, use.names = TRUE)

ggplotly(volcano.d0.narrow.boost)

```

**BOOST: Day 0 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d0-broad}
sample_data(ps1)$day
ps1.d0.broad <- subset_samples(ps1.broad, day == "0")
sample_data(ps1.d0.broad)$day
sample_data(ps1.d0.broad)$randomization_arm

# Differential Abundance Testing
ds.d0.broad <- phyloseq_to_deseq2(ps1.d0.broad, ~d7_rota_boost_updated)

geoMeans.ds.d0.broad <- apply(counts(ds.d0.broad), 1, gm_mean)
ds.d0.broad <- estimateSizeFactors(ds.d0.broad, geoMeans = geoMeans.ds.d0.broad)

dds.d0.broad <- DESeq(ds.d0.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d0.broad = results(dds.d0.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d0.broad = res.dds.d0.broad[which(res.dds.d0.broad$padj < alpha), ]
sigtab_dds.dds.d0.broad = cbind(as(sigtab_dds.dds.d0.broad, "data.frame"), as(tax_table(ps1.d0.broad)[rownames(sigtab_dds.dds.d0.broad), ], "matrix"))
summary(res.dds.d0.broad)

# No significantly different taxa at Day 0 in Broad Spectrum Antibiotics
# Quick check of factor levels
mcols(res.dds.d0.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d0.broad = data.table(as(results(dds.d0.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d0.broad, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d0.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d0.broad, "OTU")
resdt.dds.d0.broad <- taxdt.dds.d0.com[resdt.dds.d0.broad]
resdt.dds.d0.broad
resdt.dds.d0.broad[, Significant := padj < alpha]
resdt.dds.d0.broad[!is.na(Significant)]
resdt.dds.d0.broad

volcano.d0.broad.boost = ggplot(
  data = resdt.dds.d0.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d0.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 0 Broad Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d0.broad.boost
summary(res.dds.d0.broad)
mcols(res.dds.d0.broad, use.names = TRUE)

ggplotly(volcano.d0.broad.boost)

```

**DAY -9**

**BOOST: Day -9 Control**
```{r differential-abundance-testing-boost-d.9-control}
sample_data(ps1)$day
ps1.d.9.con <- subset_samples(ps1.con, day == "-9")
sample_data(ps1.d.9.con)$day
sample_data(ps1.d.9.con)$randomization_arm

# Differential Abundance Testing
ds.d.9.con <- phyloseq_to_deseq2(ps1.d.9.con, ~d7_rota_boost_updated)

geoMeans.ds.d.9.con <- apply(counts(ds.d.9.con), 1, gm_mean)
ds.d.9.con <- estimateSizeFactors(ds.d.9.con, geoMeans = geoMeans.ds.d.9.con)

dds.d.9.con <- DESeq(ds.d.9.con, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d.9.con = results(dds.d.9.con, cooksCutoff = FALSE)
sigtab_dds.dds.d.9.con = res.dds.d.9.con[which(res.dds.d.9.con$padj < alpha), ]
sigtab_dds.dds.d.9.con = cbind(as(sigtab_dds.dds.d.9.con, "data.frame"), as(tax_table(ps1.d.9.con)[rownames(sigtab_dds.dds.d.9.con), ], "matrix"))
summary(res.dds.d.9.con)
head(sigtab_dds.dds.d.9.con)
write.table(sigtab_dds.dds.d.9.con, file="./results/deseq_d.9_con_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d.9.con, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d.9.con = data.table(as(results(dds.d.9.con, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d.9.con, "rn", "OTU")
taxdt.dds.d.9.com = data.table(data.frame(as(tax_table(ps1.d.9.con), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d.9.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d.9.com, "OTU")
setkeyv(resdt.dds.d.9.con, "OTU")
resdt.dds.d.9.con <- taxdt.dds.d.9.com[resdt.dds.d.9.con]
resdt.dds.d.9.con
resdt.dds.d.9.con[, Significant := padj < alpha]
resdt.dds.d.9.con[!is.na(Significant)]
resdt.dds.d.9.con

volcano.d.9.con.boost = ggplot(
  data = resdt.dds.d.9.con[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d.9.con[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay -9 Control ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d.9.con.boost
summary(res.dds.d.9.con)
mcols(res.dds.d.9.con, use.names = TRUE)

ggplotly(volcano.d.9.con.boost)

```

**BOOST: Day -9 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d.9-narrow}
sample_data(ps1)$day
ps1.d.9.narrow <- subset_samples(ps1.narrow, day == "-9")
sample_data(ps1.d.9.narrow)$day
sample_data(ps1.d.9.narrow)$randomization_arm

# Differential Abundance Testing
ds.d.9.narrow <- phyloseq_to_deseq2(ps1.d.9.narrow, ~d7_rota_boost_updated)

geoMeans.ds.d.9.narrow <- apply(counts(ds.d.9.narrow), 1, gm_mean)
ds.d.9.narrow <- estimateSizeFactors(ds.d.9.narrow, geoMeans = geoMeans.ds.d.9.narrow)

dds.d.9.narrow <- DESeq(ds.d.9.narrow, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d.9.narrow = results(dds.d.9.narrow, cooksCutoff = FALSE)
sigtab_dds.dds.d.9.narrow = res.dds.d.9.narrow[which(res.dds.d.9.narrow$padj < alpha), ]
sigtab_dds.dds.d.9.narrow = cbind(as(sigtab_dds.dds.d.9.narrow, "data.frame"), as(tax_table(ps1.d.9.narrow)[rownames(sigtab_dds.dds.d.9.narrow), ], "matrix"))
summary(res.dds.d.9.narrow)
head(sigtab_dds.dds.d.9.narrow)
write.table(sigtab_dds.dds.d.9.narrow, file="./results/deseq_d.9_narrow_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d.9.narrow, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d.9.narrow = data.table(as(results(dds.d.9.narrow, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d.9.narrow, "rn", "OTU")
taxdt.dds.d.9.com = data.table(data.frame(as(tax_table(ps1.d.9.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d.9.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d.9.com, "OTU")
setkeyv(resdt.dds.d.9.narrow, "OTU")
resdt.dds.d.9.narrow <- taxdt.dds.d.9.com[resdt.dds.d.9.narrow]
resdt.dds.d.9.narrow
resdt.dds.d.9.narrow[, Significant := padj < alpha]
resdt.dds.d.9.narrow[!is.na(Significant)]
resdt.dds.d.9.narrow

volcano.d.9.narrow.boost = ggplot(
  data = resdt.dds.d.9.narrow[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d.9.narrow[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay -9 Narrow Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d.9.narrow.boost
summary(res.dds.d.9.narrow)
mcols(res.dds.d.9.narrow, use.names = TRUE)

ggplotly(volcano.d.9.narrow.boost)

```

**BOOST: Day -9 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-boost-d.9-broad}
sample_data(ps1)$day
ps1.d.9.broad <- subset_samples(ps1.broad, day == "-9")
sample_data(ps1.d.9.broad)$day

# Differential Abundance Testing
ds.d.9.broad <- phyloseq_to_deseq2(ps1.d.9.broad, ~d7_rota_boost_updated)

geoMeans.ds.d.9.broad <- apply(counts(ds.d.9.broad), 1, gm_mean)
ds.d.9.broad <- estimateSizeFactors(ds.d.9.broad, geoMeans = geoMeans.ds.d.9.broad)

dds.d.9.broad <- DESeq(ds.d.9.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d.9.broad = results(dds.d.9.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d.9.broad = res.dds.d.9.broad[which(res.dds.d.9.broad$padj < alpha), ]
sigtab_dds.dds.d.9.broad = cbind(as(sigtab_dds.dds.d.9.broad, "data.frame"), as(tax_table(ps1.d.9.broad)[rownames(sigtab_dds.dds.d.9.broad), ], "matrix"))
summary(res.dds.d.9.broad)
head(sigtab_dds.dds.d.9.broad)
write.table(sigtab_dds.dds.d.9.broad, file="./results/deseq_d.9_broad_rota_boost.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d.9.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d.9.broad = data.table(as(results(dds.d.9.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d.9.broad, "rn", "OTU")
taxdt.dds.d.9.com = data.table(data.frame(as(tax_table(ps1.d.9.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d.9.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d.9.com, "OTU")
setkeyv(resdt.dds.d.9.broad, "OTU")
resdt.dds.d.9.broad <- taxdt.dds.d.9.com[resdt.dds.d.9.broad]
resdt.dds.d.9.broad
resdt.dds.d.9.broad[, Significant := padj < alpha]
resdt.dds.d.9.broad[!is.na(Significant)]
resdt.dds.d.9.broad

volcano.d.9.broad.boost = ggplot(
  data = resdt.dds.d.9.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d.9.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay -9 Broad Spectrum Antibiotics ~ Rotavirus Boost") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d.9.broad.boost
summary(res.dds.d.9.broad)
mcols(res.dds.d.9.broad, use.names = TRUE)

ggplotly(volcano.d.9.broad.boost)

```

```{r day7-boost-grid}
grid.arrange(volcano.d.9.con.boost, volcano.d0.con.boost, volcano.d7.con.boost, volcano.d.9.narrow.boost, volcano.d0.narrow.boost, volcano.d7.narrow.boost, volcano.d.9.broad.boost,  volcano.d0.broad.boost, volcano.d7.broad.boost, nrow = 3, ncol = 3)

```

**Shedding**

**Shedding: Day 7 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d7-narrow}
# Differential Abundance Testing
ds.d7.narrow.shed <- phyloseq_to_deseq2(ps1.d7.narrow, ~Shedding)

geoMeans.ds.d7.narrow.shed <- apply(counts(ds.d7.narrow.shed), 1, gm_mean)
ds.d7.narrow.shed <- estimateSizeFactors(ds.d7.narrow.shed, geoMeans = geoMeans.ds.d7.narrow.shed)

dds.d7.narrow.shed <- DESeq(ds.d7.narrow.shed, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.narrow.shed = results(dds.d7.narrow.shed, cooksCutoff = FALSE)
sigtab_dds.dds.d7.narrow.shed = res.dds.d7.narrow.shed[which(res.dds.d7.narrow.shed$padj < alpha), ]
sigtab_dds.dds.d7.narrow.shed = cbind(as(sigtab_dds.dds.d7.narrow.shed, "data.frame"), as(tax_table(ps1.d7.narrow)[rownames(sigtab_dds.dds.d7.narrow.shed), ], "matrix"))
summary(res.dds.d7.narrow.shed)
head(sigtab_dds.dds.d7.narrow.shed)
write.table(sigtab_dds.dds.d7.narrow.shed, file="./results/deseq_d7_narrow_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.narrow.shed, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.narrow.shed = data.table(as(results(dds.d7.narrow.shed, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.narrow.shed, "rn", "OTU")
taxdt.dds.d7.com = data.table(data.frame(as(tax_table(ps1.d7.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d7.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d7.com, "OTU")
setkeyv(resdt.dds.d7.narrow.shed, "OTU")
resdt.dds.d7.narrow.shed <- taxdt.dds.d7.com[resdt.dds.d7.narrow.shed]
resdt.dds.d7.narrow.shed
resdt.dds.d7.narrow.shed[, Significant := padj < alpha]
resdt.dds.d7.narrow.shed[!is.na(Significant)]
resdt.dds.d7.narrow.shed

volcano.d7.narrow.shed = ggplot(
  data = resdt.dds.d7.narrow.shed[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.narrow.shed[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Narrow Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.narrow.shed
summary(res.dds.d7.narrow.shed)
mcols(res.dds.d7.narrow.shed, use.names = TRUE)

ggplotly(volcano.d7.narrow.shed)

```

**Shedding: Day 7 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d7-broad}
# Differential Abundance Testing
ds.d7.broad <- phyloseq_to_deseq2(ps1.d7.broad, ~Shedding)

geoMeans.ds.d7.broad <- apply(counts(ds.d7.broad), 1, gm_mean)
ds.d7.broad <- estimateSizeFactors(ds.d7.broad, geoMeans = geoMeans.ds.d7.broad)

dds.d7.broad <- DESeq(ds.d7.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.broad = results(dds.d7.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d7.broad = res.dds.d7.broad[which(res.dds.d7.broad$padj < alpha), ]
sigtab_dds.dds.d7.broad = cbind(as(sigtab_dds.dds.d7.broad, "data.frame"), as(tax_table(ps1.d7.broad)[rownames(sigtab_dds.dds.d7.broad), ], "matrix"))
summary(res.dds.d7.broad)
head(sigtab_dds.dds.d7.broad)
write.table(sigtab_dds.dds.d7.broad, file="./results/deseq_d7_broad_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.broad = data.table(as(results(dds.d7.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.broad, "rn", "OTU")
taxdt.dds.d7.com = data.table(data.frame(as(tax_table(ps1.d7.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d7.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d7.com, "OTU")
setkeyv(resdt.dds.d7.broad, "OTU")
resdt.dds.d7.broad <- taxdt.dds.d7.com[resdt.dds.d7.broad]
resdt.dds.d7.broad
resdt.dds.d7.broad[, Significant := padj < alpha]
resdt.dds.d7.broad[!is.na(Significant)]
resdt.dds.d7.broad

volcano.d7.broad.shed = ggplot(
  data = resdt.dds.d7.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Broad Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.broad.shed
summary(res.dds.d7.broad)
mcols(res.dds.d7.broad, use.names = TRUE)

ggplotly(volcano.d7.broad.shed)

```

```{r day7-shed-grid}
grid.arrange(volcano.d7.narrow.shed, volcano.d7.broad.shed, ncol = 2)

```

**Shedding: Day 0 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d0-narrow}
# Differential Abundance Testing
ds.d0.narrow.shed <- phyloseq_to_deseq2(ps1.d0.narrow, ~Shedding)

geoMeans.ds.d0.narrow.shed <- apply(counts(ds.d0.narrow.shed), 1, gm_mean)
ds.d0.narrow.shed <- estimateSizeFactors(ds.d0.narrow.shed, geoMeans = geoMeans.ds.d0.narrow.shed)

dds.d0.narrow.shed <- DESeq(ds.d0.narrow.shed, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d0.narrow.shed = results(dds.d0.narrow.shed, cooksCutoff = FALSE)
sigtab_dds.dds.d0.narrow.shed = res.dds.d0.narrow.shed[which(res.dds.d0.narrow.shed$padj < alpha), ]
sigtab_dds.dds.d0.narrow.shed = cbind(as(sigtab_dds.dds.d0.narrow.shed, "data.frame"), as(tax_table(ps1.d0.narrow)[rownames(sigtab_dds.dds.d0.narrow.shed), ], "matrix"))
summary(res.dds.d0.narrow.shed)
head(sigtab_dds.dds.d0.narrow.shed)
write.table(sigtab_dds.dds.d0.narrow.shed, file="./results/deseq_d0_narrow_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d0.narrow.shed, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d0.narrow.shed = data.table(as(results(dds.d0.narrow.shed, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d0.narrow.shed, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d0.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d0.narrow.shed, "OTU")
resdt.dds.d0.narrow.shed <- taxdt.dds.d0.com[resdt.dds.d0.narrow.shed]
resdt.dds.d0.narrow.shed
resdt.dds.d0.narrow.shed[, Significant := padj < alpha]
resdt.dds.d0.narrow.shed[!is.na(Significant)]
resdt.dds.d0.narrow.shed

volcano.d0.narrow.shed = ggplot(
  data = resdt.dds.d0.narrow.shed[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d0.narrow.shed[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 0 Narrow Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d0.narrow.shed
summary(res.dds.d0.narrow.shed)
mcols(res.dds.d0.narrow.shed, use.names = TRUE)

ggplotly(volcano.d0.narrow.shed)

```

**Shedding: Day 0 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d0-broad}
# Differential Abundance Testing
ds.d0.broad <- phyloseq_to_deseq2(ps1.d0.broad, ~Shedding)

geoMeans.ds.d0.broad <- apply(counts(ds.d0.broad), 1, gm_mean)
ds.d0.broad <- estimateSizeFactors(ds.d0.broad, geoMeans = geoMeans.ds.d0.broad)

dds.d0.broad <- DESeq(ds.d0.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d0.broad = results(dds.d0.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d0.broad = res.dds.d0.broad[which(res.dds.d0.broad$padj < alpha), ]
sigtab_dds.dds.d0.broad = cbind(as(sigtab_dds.dds.d0.broad, "data.frame"), as(tax_table(ps1.d0.broad)[rownames(sigtab_dds.dds.d0.broad), ], "matrix"))
summary(res.dds.d0.broad)
head(sigtab_dds.dds.d0.broad)
write.table(sigtab_dds.dds.d0.broad, file="./results/deseq_d0_broad_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d0.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d0.broad = data.table(as(results(dds.d0.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d0.broad, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d0.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d0.broad, "OTU")
resdt.dds.d0.broad <- taxdt.dds.d0.com[resdt.dds.d0.broad]
resdt.dds.d0.broad
resdt.dds.d0.broad[, Significant := padj < alpha]
resdt.dds.d0.broad[!is.na(Significant)]
resdt.dds.d0.broad

volcano.d0.broad.shed = ggplot(
  data = resdt.dds.d0.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d0.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 0 Broad Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d0.broad.shed
summary(res.dds.d0.broad)
mcols(res.dds.d0.broad, use.names = TRUE)

ggplotly(volcano.d0.broad.shed)

```

**Shedding: Day -9 Narrow Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d.9-narrow}
# Differential Abundance Testing
ds.d.9.narrow.shed <- phyloseq_to_deseq2(ps1.d.9.narrow, ~Shedding)

geoMeans.ds.d.9.narrow.shed <- apply(counts(ds.d.9.narrow.shed), 1, gm_mean)
ds.d.9.narrow.shed <- estimateSizeFactors(ds.d.9.narrow.shed, geoMeans = geoMeans.ds.d.9.narrow.shed)

dds.d.9.narrow.shed <- DESeq(ds.d.9.narrow.shed, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d.9.narrow.shed = results(dds.d.9.narrow.shed, cooksCutoff = FALSE)
sigtab_dds.dds.d.9.narrow.shed = res.dds.d.9.narrow.shed[which(res.dds.d.9.narrow.shed$padj < alpha), ]
sigtab_dds.dds.d.9.narrow.shed = cbind(as(sigtab_dds.dds.d.9.narrow.shed, "data.frame"), as(tax_table(ps1.d.9.narrow)[rownames(sigtab_dds.dds.d.9.narrow.shed), ], "matrix"))
summary(res.dds.d.9.narrow.shed)
head(sigtab_dds.dds.d.9.narrow.shed)
write.table(sigtab_dds.dds.d.9.narrow.shed, file="./results/deseq_d.9_narrow_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d.9.narrow.shed, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d.9.narrow.shed = data.table(as(results(dds.d.9.narrow.shed, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d.9.narrow.shed, "rn", "OTU")
taxdt.dds.d.9.com = data.table(data.frame(as(tax_table(ps1.d.9.narrow), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d.9.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d.9.com, "OTU")
setkeyv(resdt.dds.d.9.narrow.shed, "OTU")
resdt.dds.d.9.narrow.shed <- taxdt.dds.d.9.com[resdt.dds.d.9.narrow.shed]
resdt.dds.d.9.narrow.shed
resdt.dds.d.9.narrow.shed[, Significant := padj < alpha]
resdt.dds.d.9.narrow.shed[!is.na(Significant)]
resdt.dds.d.9.narrow.shed

volcano.d.9.narrow.shed = ggplot(
  data = resdt.dds.d.9.narrow.shed[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d.9.narrow.shed[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay -9 Narrow Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d.9.narrow.shed
summary(res.dds.d.9.narrow.shed)
mcols(res.dds.d.9.narrow.shed, use.names = TRUE)

ggplotly(volcano.d.9.narrow.shed)

```

**Shedding: Day -9 Broad Spectrum Antibiotics**
```{r differential-abundance-testing-Shedding-d.9-broad}
# Differential Abundance Testing
ds.d.9.broad <- phyloseq_to_deseq2(ps1.d.9.broad, ~Shedding)

geoMeans.ds.d.9.broad <- apply(counts(ds.d.9.broad), 1, gm_mean)
ds.d.9.broad <- estimateSizeFactors(ds.d.9.broad, geoMeans = geoMeans.ds.d.9.broad)

dds.d.9.broad <- DESeq(ds.d.9.broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d.9.broad = results(dds.d.9.broad, cooksCutoff = FALSE)
sigtab_dds.dds.d.9.broad = res.dds.d.9.broad[which(res.dds.d.9.broad$padj < alpha), ]
sigtab_dds.dds.d.9.broad = cbind(as(sigtab_dds.dds.d.9.broad, "data.frame"), as(tax_table(ps1.d.9.broad)[rownames(sigtab_dds.dds.d.9.broad), ], "matrix"))
summary(res.dds.d.9.broad)
head(sigtab_dds.dds.d.9.broad)
write.table(sigtab_dds.dds.d.9.broad, file="./results/deseq_d.9_broad_Shedding.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d.9.broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d.9.broad = data.table(as(results(dds.d.9.broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d.9.broad, "rn", "OTU")
taxdt.dds.d.9.com = data.table(data.frame(as(tax_table(ps1.d.9.broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d.9.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d.9.com, "OTU")
setkeyv(resdt.dds.d.9.broad, "OTU")
resdt.dds.d.9.broad <- taxdt.dds.d.9.com[resdt.dds.d.9.broad]
resdt.dds.d.9.broad
resdt.dds.d.9.broad[, Significant := padj < alpha]
resdt.dds.d.9.broad[!is.na(Significant)]
resdt.dds.d.9.broad

volcano.d.9.broad.shed = ggplot(
  data = resdt.dds.d.9.broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d.9.broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay -9 Broad Spectrum Antibiotics ~ Shedding") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d.9.broad.shed
summary(res.dds.d.9.broad)
mcols(res.dds.d.9.broad, use.names = TRUE)

ggplotly(volcano.d.9.broad.shed)

```

```{r day7-shed-grid}
grid.arrange(volcano.d.9.narrow.shed, volcano.d0.narrow.shed, volcano.d7.narrow.shed, volcano.d.9.broad.shed, volcano.d0.broad.shed, volcano.d7.broad.shed, ncol = 3, nrow = 3)

```

**BOOST: Day 7 Narrow vs. Broad**
```{r differential-abundance-testing-Shedding-d7-narrow_v_broad-by-boost, eval=FALSE}
sample_data(ps1)$day
sample_data(ps1)$d7_rota_boost_updated
sample_data(ps1)$randomization_arm
ps1.d7.boost_narrow_v_broad <- ps1 %>%
  subset_samples(
    day == "7" &
    d7_rota_boost_updated == "boost" &
    randomization_arm != "No antibiotics"
  )
sample_data(ps1.d7.boost_narrow_v_broad)$day
sample_data(ps1.d7.boost_narrow_v_broad)$d7_rota_boost_updated
sample_data(ps1.d7.boost_narrow_v_broad)$randomization_arm

# Differential Abundance Testing
ds.d7.boost_narrow_v_broad <- phyloseq_to_deseq2(ps1.d7.boost_narrow_v_broad, ~randomization_arm)

geoMeans.ds.d7.boost_narrow_v_broad <- apply(counts(ds.d7.boost_narrow_v_broad), 1, gm_mean)
ds.d7.boost_narrow_v_broad <- estimateSizeFactors(ds.d7.boost_narrow_v_broad, geoMeans = geoMeans.ds.d7.boost_narrow_v_broad)

dds.d7.boost_narrow_v_broad <- DESeq(ds.d7.boost_narrow_v_broad, test="Wald", fitType="local", betaPrior = FALSE)

alpha = 0.05

# Tabulate and write results
res.dds.d7.boost_narrow_v_broad = results(dds.d7.boost_narrow_v_broad, cooksCutoff = FALSE)
sigtab_dds.dds.d7.boost_narrow_v_broad = res.dds.d7.boost_narrow_v_broad[which(res.dds.d7.boost_narrow_v_broad$padj < alpha), ]
sigtab_dds.dds.d7.boost_narrow_v_broad = cbind(as(sigtab_dds.dds.d7.boost_narrow_v_broad, "data.frame"), as(tax_table(ps1.d7.boost_narrow_v_broad)[rownames(sigtab_dds.dds.d7.boost_narrow_v_broad), ], "matrix"))
summary(res.dds.d7.boost_narrow_v_broad)
head(sigtab_dds.dds.d7.boost_narrow_v_broad)
write.table(sigtab_dds.dds.d7.boost_narrow_v_broad, file="./results/deseq_d7_boosted_samples.txt", sep = "\t") # Change filename to save results to appropriate file

# Quick check of factor levels
mcols(res.dds.d7.boost_narrow_v_broad, use.names = TRUE)

# Prepare to join results data.table and taxonomy table
resdt.dds.d7.boost_narrow_v_broad = data.table(as(results(dds.d7.boost_narrow_v_broad, cooksCutoff = FALSE), "data.frame"),
                   keep.rownames = TRUE)
setnames(resdt.dds.d7.boost_narrow_v_broad, "rn", "OTU")
taxdt.dds.d0.com = data.table(data.frame(as(tax_table(ps1.d7.boost_narrow_v_broad), "matrix")), keep.rownames = TRUE)
setnames(taxdt.dds.d0.com, "rn", "OTU")

# Join results data.table and taxonomy table
setkeyv(taxdt.dds.d0.com, "OTU")
setkeyv(resdt.dds.d7.boost_narrow_v_broad, "OTU")
resdt.dds.d7.boost_narrow_v_broad <- taxdt.dds.d0.com[resdt.dds.d7.boost_narrow_v_broad]
resdt.dds.d7.boost_narrow_v_broad
resdt.dds.d7.boost_narrow_v_broad[, Significant := padj < alpha]
resdt.dds.d7.boost_narrow_v_broad[!is.na(Significant)]
resdt.dds.d7.boost_narrow_v_broad

volcano.d7.boost_narrow_v_broad_v_treatment = ggplot(
  data = resdt.dds.d7.boost_narrow_v_broad[!is.na(Significant)][(pvalue < 1)],
  mapping = aes(x = log2FoldChange,
                y = -log10(pvalue),
                color = Phylum,
                label = OTU, label1 = Genus)) +
  theme_bw() +
  geom_point() + 
  geom_point(data = resdt.dds.d7.boost_narrow_v_broad[(Significant)], size = 7, alpha = 0.7) + 
  # geom_text(data = resdt[(Significant)], mapping = aes(label = paste("Genus:", Genus)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5)) +
  geom_hline(yintercept = -log10(alpha)) +
  ggtitle("DESeq2 Negative Binomial Test Volcano Plot\nDay 7 Boosted ~ Narrow Vs. Broad") +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.text = element_text(size=12)) +
  geom_vline(xintercept = 0, lty = 2)
volcano.d7.boost_narrow_v_broad_v_treatment
summary(res.dds.d7.boost_narrow_v_broad)
mcols(res.dds.d7.boost_narrow_v_broad, use.names = TRUE)

ggplotly(volcano.d7.boost_narrow_v_broad_v_treatment)

```